<!DOCTYPE html>
<meta charset="utf-8">

<html>
<head>
</head>

<script src="http://d3js.org/d3.v3.min.js"></script>

<link href="https://swisnl.github.io/jQuery-contextMenu/dist/jquery.contextMenu.css" rel="stylesheet" type="text/css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="https://swisnl.github.io/jQuery-contextMenu/dist/jquery.contextMenu.js" type="text/javascript"></script>

<style>

    .link10 {
        stroke: #ccc;
        stroke-width: 3px;
        stroke-dasharray: 3, 3;
    }
    .link1 {
        stroke: #000;
        stroke-width: 3px;
    }
    .nodetext {
        pointer-events: none;
        font: 10px sans-serif;
    }
    .tralala {
        fill:green;
        font: 30px sans-serif;
        stroke-width: 3px;
        stroke-dasharray: 3, 3;
    }
    .node.type1 {
        fill:brown;
    }
    .node.type2 {
        fill:#337147;
    }
    .node.type3 {
        fill:blue;
    }
    .node.type4 {
        fill:red;
    }
    .node.type5 {
        fill:#1BC9E0;
    }
    .node.type6 {
        fill:#E01B98;
    }
    image.circle {
        cursor:pointer;
    }

    .svg-container {
        display: inline-block;
        position: relative;
        width: 100%;
        padding-bottom: 100%; /* aspect ratio */
        vertical-align: top;
        overflow: hidden;
    }

    .svg-content-responsive {
        display: inline-block;
        position: absolute;
        top: 10px;
        left: 0;
    }


</style>

<script>

var wScreen;
var hScreen;
var force = null;

// At startup.
var url_Start = "htbin/sources_types/enumerate_CIM_Process.py?xid=.&mode=json";
var theurl = url_Start;
var theurl = "http://127.0.0.1:8000/htbin/sources_types/CIM_Process/process_cwd.py?xid=CIM_Process.Handle%3D2976&mode=json";
var divSvg = null;

// Mais pourquoi data est passe en premier ? au lieu de (error,data ) ?
// Ah peut-etre d2 version 2 au lieu de 4.
function CreateDisplay(data)
{
    if( data == null )
    {
        alert("Json data is null");
        return;
    }

    //alert(JSON.stringify(data));
    var win = window,
        doc = document,
        elt = doc.documentElement,
        geb = doc.getElementsByTagName('body')[0];
    wScreen = win.innerWidth || elt.clientWidth || geb.clientWidth,
    hScreen = win.innerHeight|| elt.clientHeight|| geb.clientHeight;

    // http://stackoverflow.com/questions/16265123/resize-svg-when-window-is-resized-in-d3-js
    // This allows the resizing.
    divSvg = d3.select("body")
       .append("div")
       .classed("svg-container", true) //container class to make it responsive
       .append("svg:svg")
       //responsive SVG needs these 2 attributes and no width and height attr
       .attr("preserveAspectRatio", "xMinYMin meet")
       .attr("viewBox", "0 0 " + wScreen + " " + hScreen)
       //class to make it responsive
       .classed("svg-content-responsive", true);

    /*
    divSvg.append("defs").append("marker")
        .attr("id", "arrowhead")
        .attr("refX", 17 + 3) // must be smarter way to calculate shift
        .attr("refY", 2)
        .attr("markerWidth", 6)
        .attr("markerHeight", 4)
        .attr("orient", "auto")
        .append("path")
        .attr("d", "M 0,0 V 4 L6,2 Z"); //this is actual shape for arrowhead
    */

    force = d3.layout.force();

    FillDisplay(divSvg,data,wScreen,hScreen);
} // CreateDisplay

function RefillDisplay(data)
{
    if( data == null )
    {
        alert("Jason data is null");
        return;
    }

    console.log("RefillDisplay:"+JSON.stringify(data));

    // CreateDisplay(data);

    // Empty display.

    var node = divSvg.selectAll("g.survol_node")
        .data([])
        .exit()
        .remove();

    // var link = divSvg.selectAll("line.link")
    var link = divSvg.selectAll(".survol_line")
        .data([])
        .exit()
        .remove();

    FillDisplay(divSvg,data,wScreen,hScreen);
}

function FillDisplay(divSvg,data,w,h)
{
    force
        .nodes(data.nodes)
        .links(data.links)
        .distance(100)
        .charge(-1000)
        .size([wScreen, hScreen])
        .start();

    // var link = divSvg.selectAll("line.link")
    var link = divSvg.selectAll(".survol_line")
        .data(data.links)
        // .enter().append("line.link")
        .enter().append("svg:line")
        .attr("class", function (d) { return "link" + d.value + " survol_line"; }) // "link10"
        .attr("x1", function (d) { return d.source.x; })
        .attr("y1", function (d) { return d.source.y; })
        .attr("x2", function (d) { return d.target.x; })
        .attr("y2", function (d) { return d.target.y; })
        // "Error in parsing value for "markedr-end": This is why I removed this.
        // .attr("marker-end", function (d) { if (d.value == 1) { return "url(#arrowhead)"; } else { return " "; }; })
        ;


    function openLinkSimpleOpen() {
        console.log("openLinkSimpleOpen");
        return function (d) { window.open(d.survol_url); }
    }

    // Left-click on a SVG object.
    function openLink()
    {
        console.log("openLink");

        function LinkOpener(d)
        {
            console.log("LinkOpener");
            function ReopenUrl(err,dataJson)
            {
                console.log("ReopenUrl");
                FillDisplay(divSvg,data,force);
            }

            // This expects a graph, not a contextual menu.
            theurl = d.survol_url + "&mode=json";
            theurl = url_Start;
            console.log("LinkOpener theurl="+theurl);
            d3.json(theurl, RefillDisplay);
        }

        return LinkOpener;
    }


    function NodeLeftClick(d)
    {
        console.log("NodeLeftClick");

        // This expects a graph, not a contextual menu.
        theurl = d.survol_url + "&mode=json";
        // theurl = url_Start;
        console.log("LinkOpener theurl="+theurl);
        alert("theurl="+theurl);
        d3.json(theurl, RefillDisplay);
    }

    // Creates one SVG object (Which class ?) for each survol node.
    var node = divSvg.selectAll("g.node")
        .data(data.nodes)
        .enter().append("svg:g")
        .attr("class", function (d) { return "survol_node node"; }) // Two classes are possible.
        .call(force.drag);

    // fill:#337147;

    // The class is a CSS style: ".node.type1" etc...

    d3.selectAll(".survol_node").append("rect")
        .attr("width", 50)
        .attr("height", 20)
        .attr("fill", function (d) { return d.fill; })
        .attr("class", function (d) { return d.entity_class; }) // Classes are not defined so colors are OK.
        //.attr("class", function (d) { return "node type" + d.type; })
        .append("svg:title").text(function(d) { return d.title; })
        ;

    var radius = d3.scale.log().domain([0, 312000]).range(["10", "50"]);

    d3.selectAll(".circle").append("circle")
        .attr("class", function (d) { return "node type" + d.type; })
        .attr("r", function (d) { return radius(d.value) || 10; }).call(force.drag);

    // Maybe the click zone on each survol node ???????
    // Why is it invisible ??
    // Why not a "mousedown" ??
    node.append("svg:image")
        .attr("class", "circle")
        .attr("xlink:href", function (d) { return d.img_href; })
        .attr("x", "-16px")
        .attr("y", "-16px")
        .attr("width", "32px")
        .attr("height", "32px")
        .on("click", NodeLeftClick);

    // This is the text associated to each survol node.
    node.append("svg:text")
        .attr("class", "nodetext")
        .attr("dx", 0)
        .attr("dy", ".35em")
        .attr("text-anchor", "middle")
        .text(function (d) { return d.name; });

    function tick_function()
    {
        // Apply the constraints: On verra plus tard. http://bl.ocks.org/GerHobbelt/3669455

        link.attr("x1", function (d) { return d.source.x; })
            .attr("y1", function (d) { return d.source.y; })
            .attr("x2", function (d) { return d.target.x; })
            .attr("y2", function (d) { return d.target.y; });

        node.attr("transform", function (d) {
            return "translate(" + d.x + "," + d.y + ")";
        });
    }

    force.on("tick", tick_function);


    // This returns the contextual menu.
    function MakeContextMenuItems(objKey,objDfd)
    {
        console.log("MakeContextMenuItems objKey="+objKey);

        // https://swisnl.github.io/jQuery-contextMenu/demo/async-promise.html Submenu through promise.
        var menusSurvol = objDfd.promise();

        /* Peut-etre ajouter des URLs specifiques pour WMI et OpenWBEM ce qui justifierait qu'on aie
        des scripts Python specifiques.
        */

        TheItems =
        {
            CtxtMenuTitle: {
                name: objKey
            },
            yesno: {
                name: "Merge graphs",
                type: 'checkbox',
                selected: false
            },
            name: {
                name: "Text",
                type: 'text',
                value: "Hello World",
                events: {
                    keyup: function(e) {
                        // add some fancy key handling here?
                        window.console && console.log('key: '+ e.keyCode);
                    }
                }
            },
            "sep1": "---------",
            "SurvolMenu": {
                name: "Survol",
                icon: "delete",
                items: menusSurvol,
            },
            "xxxxx": {
                "name": "Sub group",
                "items": {
                    "fold1-key1": {"name": "Foo bar"},
                    "fold2": {
                        "name": "Sub group 2",
                        "items": {
                            "edit": {"name": "Edit", "icon": "edit"},
                            "cut": {"name": "Cut", "icon": "cut"},
                            "delete": {"name": "Del", "icon": "delete"},
                            "quit": {"name": "Quit", "icon": "quit"},
                        }
                    },
                    "fold1-key3": {"name": "delta"}
                }
            }
        };

        return TheItems;
    } // MakeContextMenuItems

    // Called after the page is loaded. It adds a context menu to each node,
    // therefore the nodes must be created.
    function CreateContextMenus(){
        console.log("CreateContextMenus");
        $.contextMenu({
            selector: 'g.survol_node',
            build: function($trigger, e) {
                // this callback is executed every time the menu is to be shown
                // its results are destroyed every time the menu is hidden
                // e is the original contextmenu event, containing e.pageX and e.pageY (amongst other data)
                // console.log("$trigger="+JSON.stringify($trigger));
                console.log("$trigger="+JSON.stringify($trigger["0"]["__data__"]));

                var objectSvg = $trigger["0"]["__data__"];

                var theItems = MakeContextMenuItems(objectSvg.name,objectSvg.dfd);

                return {
                    callback: function(key, options) {
                        // This is executed when an option is chosen in a contextual menu.
                        var m = "clicked: " + key;
                        window.console && console.log(m) || alert(m);

                        // This is a Python script, not a contextual menu displayed by "entity.py".
                        theUrl = key + "&mode=json";
                        console.log("theUrl="+theUrl);
                        d3.json(theUrl, RefillDisplay);

                    },
                    items: theItems
                };
            }
        });
    }; // CreateContextMenus


    // When the mouse right button is down, this loads the contextual menu content into the SVG object.
    // When this right button is released, it triggers the contextual menu which finds its content
    // stored in the SVG object.
    $("g.node").mousedown(function(ev){
        // alert("rc");

        /* Si clicke gauche, on va vers le "entity.py".

        TODO: Mixer les SVG avec des graphes et des trees.

        A terme, ne pas utiliser le JSON mais charger le fichier CSS dans le directory de la classe.
        */

        if(ev.which == 3)
        {
            // alert("rc3");
            var objectThis = this;
            function GetEntityUrl(jsonData)
            {
                // console.log("ENTITY="+JSON.stringify(jsonData));
                // console.log("REBELOTE:"+objectThis.__data__.survol_url);

                // Maybe this duplicates the value. Not a problem.
                objectThis.__data__.contextual_menu_items = jsonData;

                objectThis.__data__.dfd.resolve(jsonData);
            }

            // console.log("Before:");

            // "{"__data__":{"name":"erlsrv.exe","title":"{u'pid': 3764}","entity":"company","type":3,"slug":"http://127.0.0.1:8000/htbin/entity.py?xid=CIM_Process.Handle=3764","fill":"#99FF88","index":13,"weight":2,"x":799.1007978181673,"y":367.4837488000358,"px":799.7278005857847,"py":367.3954435486226},"jQuery11130282863608954682":15}" survol_d3_2.htm:339:1
            // console.log(JSON.stringify(this));

            // We expect a contextual menu, not a graph.
            var urlEntity = this.__data__.survol_url + "&mode=menu";
            console.log("URL:"+urlEntity);

            this.__data__.dfd = jQuery.Deferred();

            d3.json(urlEntity, GetEntityUrl);

            // "{"0":{"__data__":{"name":"erlsrv.exe","title":"{u'pid': 3764}","entity":"company","type":3,"slug":"http://127.0.0.1:8000/htbin/entity.py?xid=CIM_Process.Handle=3764","fill":"#99FF88","index":13,"weight":2,"x":799.1007978181673,"y":367.4837488000358,"px":799.7278005857847,"py":367.3954435486226},"jQuery11130282863608954682":15},"context":{"__data__":{"name":"erlsrv.exe","title":"{u'pid': 3764}","entity":"company","type":3,"slug":"http://127.0.0.1:8000/htbin/entity.py?xid=CIM_Process.Handle=3764","fill":"#99FF88","index":13,"weight":2,"x":799.1007978181673,"y":367.4837488000358,"px":799.7278005857847,"py":367.3954435486226},"jQuery11130282863608954682":15},"length":1}" survol_d3_2.htm:340:1
            // console.log(JSON.stringify($(this)));
            // console.log("Pouet:");
        }
    });

    // Call function after page load: http://stackoverflow.com/questions/890090/jquery-call-function-after-load
    $(CreateContextMenus);
} // FillDisplay

// alert("theurl="+theurl);
d3.json(theurl, CreateDisplay);

/*
http://bl.ocks.org/GerHobbelt/3669455
Rester dans la partie visible : Voir la fonction.
RDF doit passer la contrainte sur les propriétés: Ajouter des triplets RDF qui expriment le layout hierarchique:
« Layout »  property  « valeur »
Mais il n est pas certain que ca suffise quand on a beaucoup d’objets.
*/

</script>


<body>
Test D3


</body>
</html>
