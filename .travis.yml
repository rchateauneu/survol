# Big Thank You to https://github.com/cclauss/Travis-CI-Python-on-three-OSes/blob/master/.travis.yml
language: python            # this works for Linux but is an error on macOS or Windows
matrix:
  include:
    - name: "Python 2.7 Linux"
      os: linux
      python: 2.7
      addons:
        apt:
          packages:
            - graphviz
      before_install:
        - pip install supervisor # Optional, needed for events generators.
        - pip install demangler pyelftools
    - name: "Python 3.6 Linux"
      os: linux
      python: 3.6
      addons:
        apt:
          packages:
            - graphviz
      before_install:
        - pip install supervisor  # Optional, needed for events generators.
        - pip install demangler pyelftools
    - name: "Python 3.7.5 on Windows"
      os: windows           # Windows 10.0.17134 N/A Build 17134
      language: shell       # 'language: python' is an error on Travis CI Windows
      # python: 3.7         # 'python:' is ignored on Travis CI Windows
      before_install:
        # https://travis-ci.community/t/windows-python-pip-module-not-found/5480/4
        ##- choco install python  --version 3.7.5
        ##- python -m ensurepip
        # Suddenly: "python -m pip install --upgrade pip" failed and exited with 1 during"
        # No module named pip
        ### - python -m pip install --upgrade pip
        # This seems to run on Linux.
        - echo "In before_install"
        - choco install python  --version 3.7.5
        # /c/Users/travis/build/rchateauneu/survol
        - pwd
        # /c/ProgramData/chocolatey/bin/python
        - which python
        - dir `which python`
        # Python 2.7.9
        - python -V
        #- which python3
        #- python -m ensurepip
        #- choco install pip
        #- pip install pytest
        #- python -m pip install pytest
        #- python -m pip install --upgrade pip
        #- python -m pip install pytest         # Optional
        #- python -m pip install pefile         # Optional
        #- python -m pip install wmi            # Optional
        #- python -m pip install pywin32        # Optional
        #- python -m pip install pyodbc         # Optional
        #- python -m pip install supervisor-win # Optional, needed for events generators.
      install:
        # Is it possible to have an install step specific to a platform ?
        - echo "In install"
        - which python
        - python -V
        - powershell python -V
        #
        # https://kendaleiv.com/using-sql-server-localdb-with-travis-ci-windows-builds/
        # Travis CI now includes support for Windows builds.
        # It doesn’t have SQL Server LocalDB installed by default currently, but it’s easy to install.
        # More explanations about
        # https://docs.microsoft.com/en-us/sql/database-engine/configure-windows/sql-server-express-localdb
        # Here’s an example Travis CI configuration that installs it using Chocolatey:
        #
        # Use mssqlserver2014-sqllocaldb rather than sqllocaldb package which has an issue:
        # https://dba.stackexchange.com/questions/191393/localdb-v14-creates-wrong-path-for-mdf-files
        #
        # TODO: Must be tested.
        #
        # https://community.chocolatey.org/packages?q=SqlServer
        #
        # OK: choco install mssqlserver2014-sqllocaldb
        # "was not successful. Exit code was '-2146233079'": choco install sql-server-express -y
        # No output has been received in the last 10m0s
        # - choco install sqlserver2014express
        #- powershell -Command "Set-ExecutionPolicy Bypass"
        #- choco install sqlserver2014express -v -y
        #
        # Many various attempts:
        ##- choco install sqlserver-odbcdriver
        #### - choco install mssqlserver-compact4.0
        ####- choco install sqlserverlocaldb
        # - choco install sqlserverexpress
        ##- choco install sql-server-express
        # choco install sqlserver2008r2express-engine
        # - choco install sqlserver2012express-engine # sqlserver2012express-engine was NOT successful
        # - choco install MsSqlServer2014Express --cachelocation c:\temp\choco
        # - choco install MsSqlServer2014Express --verbose
        #
        # https://stackoverflow.com/questions/51840565/error-there-was-an-error-generating-the-xml-document-while-trying-to-install-s
        # To fix: "There was an error generating the XML document"
        # This hangs.
        # - powershell Enable-WSManCredSSP -Role "Server"
        #
        # Timeout with Enable-WSManCredSSP -Role "Server"
        #- choco install MsSqlServer2014Express --verbose --trace
        - powershell -Command "Set-ExecutionPolicy Bypass"
        #
        # Partly not found
        #- choco install sqlserverexpress -- verbose --trace
        #
        # - choco install SqlServer2008R2Express --verbose --trace
        # Make the command always successful
        - (choco install SqlServer2008R2Express --verbose --trace); type C:\ProgramData\chocolatey\logs\chocolatey.log
        # - choco install mssqlexpress2014sp1wt
        #
        # Cannot find any service with service name 'MSSQL'
        ### - powershell Start-Service "MSSQL$SQLEXPRESS"
        #
        # Cannot find any service with service name 'MSSQL\\'
        # powershell Start-Service 'MSSQL\\$SQLEXPRESS'
        #
        # Start-Service : Cannot find any service with service name 'MSSQL$SQLEXPRESS'.
        #
        #At line:1 char:1
        #
        #+ Start-Service MSSQL`$SQLEXPRESS
        #
        ### powershell Start-Service SQLEXPRESS
        #
        #
        # List of services
        - powershell Get-Service
        #
        #
        #      env:
        - PATH=/c/Python37:/c/Python37/Scripts:$PATH
      after_failure:
        - cat C:\ProgramData\chocolatey\logs\chocolatey.log
      script:
        - echo "In script"
        - python -V
        - powershell python -V
        #
        - python -m pip install --upgrade pip
        # Specific to Windows.
        - pip install pytest
        - pip install pefile         # Optional
        - pip install wmi            # Optional
        - pip install pywin32        # Optional
        - pip install pyodbc         # Optional
        - pip install supervisor-win # Optional, needed for events generators.
        #
        # For all platforms.
        - pip install psutil               # Mandatory
        - pip install rdflib               # Mandatory
        - pip install SQLAlchemy==1.3.23   # 1.4 does not work with rdflib-sqlalchemy:0.4.0
        - pip install rdflib-sqlalchemy    # Optional, needed for events generators.
        - pip install SPARQLWrapper        # Optional
        - pip install pywbem               # Optional
        - pip install sqlparse             # Optional
        - pip install natsort              # Optional, needed for nicer sorts.
        - pip install twisted              # Optional
        #
        # Do it elsewhere than Linux.
        - pytest -v --durations=30 tests
        #
      #services:
      #  # https://docs:travis-ci.com/user/database-setup/
      #  #- MSSQLServer
      #  #- SQLEXPRESS
      #  - MSSQL$SQLEXPRESS

install:
  # TODO: For all platforms but overriden by Windows configuration.
  - pip install psutil               # Mandatory
  - pip install rdflib               # Mandatory
  - pip install SQLAlchemy==1.3.23   # 1.4 does not work with rdflib-sqlalchemy:0.4.0
  - pip install rdflib-sqlalchemy    # Optional, needed for events generators.
  - pip install SPARQLWrapper        # Optional
  - pip install pywbem               # Optional
  - pip install sqlparse             # Optional
  - pip install natsort              # Optional, needed for nicer sorts.
  - pip install twisted              # Optional
script:
  - pytest -v --durations=30 tests

